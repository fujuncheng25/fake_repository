<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理控制台 - 流浪猫公益项目</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .admin-section h2 {
            background-color: #4CAF50;
            color: white;
            padding: 15px 20px;
            margin: 0;
        }
        
        .admin-content {
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4CAF50;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .cat-summary-row td {
            vertical-align: middle;
        }

        .cat-detail-row.hidden {
            display: none;
        }

        .cat-detail-card {
            background-color: #ffffff;
            border: 1px solid #e8e8e8;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .cat-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }

        .cat-detail-header h3 {
            margin: 0 0 8px;
        }

        .cat-detail-body {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            margin-top: 18px;
        }

        .cat-detail-body > * {
            flex: 1 1 280px;
        }

        .cat-image-wrapper {
            max-width: 280px;
        }

        .cat-detail-image {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }

        .cat-detail-placeholder {
            width: 100%;
            min-height: 160px;
            background: repeating-linear-gradient(135deg, #f5f5f5, #f5f5f5 10px, #eaeaea 10px, #eaeaea 20px);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #888;
            font-size: 0.9rem;
        }

        .cat-meta dl {
            margin: 0;
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 18px;
        }

        .cat-meta dt {
            font-weight: 600;
            color: #444;
        }

        .cat-meta dd {
            margin: 0;
            color: #555;
            line-height: 1.5;
        }

        .cat-description {
            background-color: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            line-height: 1.6;
            color: #333;
        }

        .cat-feedback textarea,
        .cat-feedback input[type="text"] {
            width: 100%;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .cat-feedback textarea {
            min-height: 120px;
            resize: vertical;
        }

        .feedback-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 12px;
        }

        .feedback-status {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px 10px;
            color: #666;
            font-size: 1rem;
        }

        .cat-basic {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cat-basic .cat-name {
            font-weight: 600;
        }

        .cat-basic .cat-badge {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: #eef2f7;
            color: #53738c;
        }

        .btn-link {
            background: none;
            border: none;
            color: #4CAF50;
            cursor: pointer;
            padding: 0;
            font-size: 0.9rem;
        }

        .btn-link:hover {
            text-decoration: underline;
        }

        .action-buttons.stacked {
            flex-direction: column;
            align-items: flex-start;
        }

        .section-count {
            font-size: 0.85rem;
            color: #666;
            margin-left: 8px;
        }

        .admin-message {
            display: none;
            margin-bottom: 20px;
            padding: 12px 16px;
            border-radius: 6px;
            border: 1px solid transparent;
            font-size: 0.95rem;
        }

        .admin-message.show {
            display: block;
        }

        .admin-message.success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .admin-message.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .admin-message.info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .recognition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .panel-card {
            background-color: #ffffff;
            border: 1px solid #e4e4e4;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .panel-card h3 {
            margin-top: 0;
            margin-bottom: 12px;
        }

        .form-grid {
            display: grid;
            gap: 12px;
        }

        .form-grid.two-column {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .form-grid label {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .form-grid input[type="text"],
        .form-grid input[type="number"],
        .form-grid input[type="email"],
        .form-grid textarea,
        .form-grid select {
            padding: 9px 10px;
            border: 1px solid #d5d5d5;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .form-grid textarea {
            min-height: 96px;
            resize: vertical;
        }

        .switch-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .switch-row label {
            flex-direction: row;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .info-note {
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
        }

        .status-bar {
            margin-top: 12px;
            font-size: 0.9rem;
        }

        .status-bar.success {
            color: #2f8f46;
        }

        .status-bar.error {
            color: #c0392b;
        }

        .file-input {
            margin-top: 12px;
        }

        .reference-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 12px;
        }

        .reference-preview img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.9rem;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #e2e2e2;
            padding: 8px 10px;
            text-align: left;
        }

        .data-table th {
            background-color: #f5f5f5;
            font-weight: 600;
            white-space: nowrap;
        }

        .data-table tbody tr:nth-child(odd) {
            background-color: #fafafa;
        }

        .table-wrapper {
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>流浪猫公益项目 - 管理控制台</h1>
            <nav>
                <ul>
                    <li><a href="/">返回首页</a></li>
                    <li><a href="/about">关于我们</a></li>
                    <li><a href="/contact">联系我们</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <button id="logoutBtn" class="logout-btn">退出登录</button>
            </div>
        </div>
    </header>

    <main>
        <div class="admin-container">
            <div class="admin-header">
                <div>
                    <h2>管理控制台</h2>
                    <p>欢迎，管理员</p>
                </div>
                <div>
                    <button id="refreshBtn" class="btn btn-primary">刷新数据</button>
                </div>
            </div>
            <div id="adminMessageBar" class="admin-message" role="status" aria-live="polite"></div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="catsCount">0</div>
                    <div class="stat-label">猫咪总数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="usersCount">0</div>
                    <div class="stat-label">注册用户</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="requestsCount">0</div>
                    <div class="stat-label">领养申请</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingRequestsCount">0</div>
                    <div class="stat-label">待处理申请</div>
                </div>
            </div>

            <div class="admin-section">
                <h2>猫咪信息管理</h2>
                <div class="admin-content">
                    <table id="catsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>名字</th>
                                <th>年龄</th>
                                <th>性别</th>
                                <th>描述</th>
                                <th>上传者</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-section" id="declinedCatsSection" style="display: none;">
                <h2>已拒绝的猫咪提交 <span id="declinedCatsCount" class="section-count"></span></h2>
                <div class="admin-content">
                    <table id="declinedCatsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>名字</th>
                                <th>年龄</th>
                                <th>性别</th>
                                <th>描述</th>
                                <th>上传者</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Declined data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-section">
                <h2>猫咪编辑工具</h2>
                <div class="admin-content">
                    <p>对已经提交的猫咪档案进行编辑，或使用已有参考图片重新生成哈希值。</p>
                    <button class="admin-btn" onclick="window.location.href='/admin-cat-editor'">打开猫咪编辑器</button>
                </div>
            </div>

            <div class="admin-section">
                <h2>用户管理</h2>
                <div class="admin-content">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>姓名</th>
                                <th>邮箱</th>
                                <th>角色</th>
                                <th>验证状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-section">
                <h2>领养申请管理</h2>
                <div class="admin-content">
                    <table id="requestsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>猫咪</th>
                                <th>申请人</th>
                                <th>邮箱</th>
                                <th>联系方式</th>
                                <th>留言</th>
                                <th>状态</th>
                                <th>申请时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-section">
                <h2>内容管理</h2>
                <p>管理网站各个页面的文本内容。</p>
                <button onclick="window.location.href='/content-management'" class="admin-btn">管理网站内容</button>
            </div>

            <div class="admin-section">
                <h2>猫脸识别管理</h2>
                <div class="admin-content">
                    <div class="recognition-grid">
                        <div class="panel-card">
                            <h3>创建猫咪档案</h3>
                            <form id="catProfileForm" class="form-grid">
                                <div class="form-grid two-column">
                                    <label>猫咪名称
                                        <input type="text" id="profileName" required placeholder="例如：小花">
                                    </label>
                                    <label>性别
                                        <select id="profileGender" required>
                                            <option value="">请选择</option>
                                            <option value="雌性">雌性</option>
                                            <option value="雄性">雄性</option>
                                            <option value="未知">未知</option>
                                        </select>
                                    </label>
                                    <label>年龄
                                        <input type="text" id="profileAge" placeholder="例如：2岁">
                                    </label>
                                    <label>识别编号
                                        <input type="text" id="profileIdentification" placeholder="内部编号（可选）">
                                    </label>
                                </div>
                                <div class="switch-row">
                                    <label><input type="checkbox" id="profileSterilized"> 已绝育</label>
                                    <label><input type="checkbox" id="profileMicrochipped"> 已植入芯片</label>
                                </div>
                                <label>特别标记
                                    <input type="text" id="profileUniqueMarkings" placeholder="例如：左耳缺角、尾巴尾端白色">
                                </label>
                                <label>最近出现地点
                                    <input type="text" id="profileLocation" placeholder="最近一次发现的地点（可选）">
                                </label>
                                <label>猫咪描述
                                    <textarea id="profileDescription" placeholder="基本性格、健康状况、救助背景等信息"></textarea>
                                </label>
                                <label>特别说明
                                    <textarea id="profileSpecialNotes" placeholder="给内部识别使用的特殊说明（可选）"></textarea>
                                </label>
                                <button type="submit" class="btn btn-primary">保存档案</button>
                                <div id="catProfileStatus" class="status-bar"></div>
                            </form>
                        </div>

                        <div class="panel-card">
                            <h3>上传识别参考图</h3>
                            <div class="form-grid">
                                <label>选择猫咪
                                    <select id="referenceCatSelect">
                                        <option value="">请先创建或选择猫咪</option>
                                    </select>
                                </label>
                                <label class="file-input">参考图像（可多选）
                                    <input type="file" id="catReferenceImages" name="images" multiple accept="image/*">
                                </label>
                                <label>主展示图策略
                                    <select id="referencePrimaryMode">
                                        <option value="auto">自动设为首张</option>
                                        <option value="none">不设置展示图</option>
                                    </select>
                                </label>
                                <button type="button" id="uploadReferenceBtn" class="btn btn-primary">上传并生成哈希</button>
                                <div id="referenceUploadStatus" class="status-bar"></div>
                                <div id="referencePreview" class="reference-preview"></div>
                            </div>
                        </div>

                        <div class="panel-card">
                            <h3>识别参数设置</h3>
                            <div class="form-grid">
                                <label>匹配阈值
                                    <input type="number" id="recognitionThreshold" step="0.01" min="0.1" max="0.99">
                                </label>
                                <label>返回结果数量
                                    <input type="number" id="recognitionMaxResults" min="1" max="10">
                                </label>
                                <label>最大哈希距离
                                    <input type="number" id="recognitionMaxHamming" min="0" placeholder="留空表示自动">
                                </label>
                                <label>模型权重路径
                                    <input type="text" id="recognitionModelPath" placeholder="本地模型文件路径或留空使用默认">
                                </label>
                                <label>哈希长度覆盖
                                    <input type="number" id="recognitionHashLength" min="64" step="1" placeholder="留空使用默认长度">
                                </label>
                                <button type="button" id="saveRecognitionSettingsBtn" class="btn btn-primary">保存识别设置</button>
                                <div id="recognitionSettingsStatus" class="status-bar"></div>
                                <div id="recognitionStats" class="info-note"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="admin-section">
                <h2>邮件服务配置</h2>
                <div class="admin-content">
                    <p>配置 Resend API 密钥以启用邮箱验证功能。</p>
                    <div style="margin: 20px 0;">
                        <label for="resendApiKey" style="display: block; margin-bottom: 10px; font-weight: bold;">
                            Resend API Key:
                        </label>
                        <input 
                            type="password" 
                            id="resendApiKey" 
                            placeholder="输入您的 Resend API 密钥"
                            style="width: 100%; max-width: 500px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                        />
                        <p id="apiKeyStatus" style="margin-top: 10px; color: #666; font-size: 14px;"></p>
                    </div>
                    <div style="margin: 20px 0;">
                        <label for="resendFromEmail" style="display: block; margin-bottom: 10px; font-weight: bold;">
                            发件人邮箱地址 (From Email):
                        </label>
                        <input 
                            type="email" 
                            id="resendFromEmail" 
                            placeholder="例如: noreply@yourdomain.com 或 your-email@resend.dev"
                            style="width: 100%; max-width: 500px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                        />
                        <p id="fromEmailStatus" style="margin-top: 10px; color: #666; font-size: 14px;"></p>
                        <p style="margin-top: 5px; color: #666; font-size: 12px;">
                            注意：在测试模式下，Resend 只允许向您自己的邮箱地址发送邮件。要发送给其他收件人，请使用已验证的域名。
                        </p>
                    </div>
                    <div style="margin: 20px 0;">
                        <label for="siteBaseUrl" style="display: block; margin-bottom: 10px; font-weight: bold;">
                            网站基础 URL (例如: https://yourdomain.com):
                        </label>
                        <input 
                            type="url" 
                            id="siteBaseUrl" 
                            placeholder="输入您网站的实际访问地址，用于邮件中的链接"
                            style="width: 100%; max-width: 500px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                        />
                        <p id="baseUrlStatus" style="margin-top: 10px; color: #666; font-size: 14px;"></p>
                        <p style="margin-top: 5px; color: #666; font-size: 12px;">
                            该 URL 将用于生成邮件中的验证链接，请确保以 http:// 或 https:// 开头。
                        </p>
                    </div>
                    <div style="margin: 20px 0;">
                        <label for="notificationFromEmail" style="display: block; margin-bottom: 10px; font-weight: bold;">
                            通知发件邮箱:
                        </label>
                        <input 
                            type="email" 
                            id="notificationFromEmail" 
                            placeholder="例如: alerts@yourdomain.com"
                            style="width: 100%; max-width: 500px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                        />
                        <p id="notificationFromEmailStatus" style="margin-top: 10px; color: #666; font-size: 14px;"></p>
                    </div>
                    <div style="margin: 20px 0;">
                        <label for="notificationEmails" style="display: block; margin-bottom: 10px; font-weight: bold;">
                            通知成员邮箱列表 (逗号或换行分隔):
                        </label>
                        <textarea 
                            id="notificationEmails" 
                            placeholder="member1@example.com, member2@example.com"
                            style="width: 100%; max-width: 500px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; min-height: 80px;"
                        ></textarea>
                        <p id="notificationEmailsStatus" style="margin-top: 10px; color: #666; font-size: 14px;"></p>
                    </div>
                    <div>
                        <button id="saveApiKeyBtn" class="btn btn-primary">保存 API 密钥</button>
                        <button id="saveFromEmailBtn" class="btn btn-primary" style="margin-left: 10px;">保存发件人邮箱</button>
                        <button id="saveBaseUrlBtn" class="btn btn-primary" style="margin-left: 10px;">保存网站 URL</button>
                        <button id="testApiKeyBtn" class="btn btn-secondary" style="margin-left: 10px;">测试连接</button>
                        <button id="saveNotificationFromEmailBtn" class="btn btn-primary" style="margin-left: 10px;">保存通知发件邮箱</button>
                        <button id="saveNotificationEmailsBtn" class="btn btn-primary" style="margin-left: 10px;">保存通知成员</button>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 4px;">
                        <h3 style="margin-top: 0;">如何获取 Resend API 密钥：</h3>
                        <ol style="line-height: 1.8;">
                            <li>访问 <a href="https://resend.com" target="_blank">resend.com</a> 并注册账户</li>
                            <li>登录后，进入 API Keys 页面</li>
                            <li>创建一个新的 API 密钥</li>
                            <li>复制密钥并粘贴到上面的输入框中</li>
                            <li>点击"保存 API 密钥"按钮</li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="admin-section">
                <h2>管理员登录链接</h2>
                <div class="admin-content">
                    <p>生成单次使用的管理员登录链接。管理员账户无法使用密码登录，必须使用生成的登录链接。</p>
                    <div style="margin: 20px 0;">
                        <label for="loginLinkExpires" style="display: block; margin-bottom: 10px; font-weight: bold;">
                            链接有效期（小时）:
                        </label>
                        <input 
                            type="number" 
                            id="loginLinkExpires" 
                            value="24"
                            min="1"
                            max="168"
                            style="width: 100%; max-width: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                        />
                        <button id="generateLoginLinkBtn" class="btn btn-primary" style="margin-left: 10px;">生成登录链接</button>
                    </div>
                    <div id="loginLinkResult" style="margin: 20px 0; padding: 15px; background-color: #f9f9f9; border-radius: 4px; display: none;">
                        <h3 style="margin-top: 0;">生成的登录链接：</h3>
                        <p style="word-break: break-all; font-family: monospace; background-color: white; padding: 10px; border-radius: 4px;">
                            <span id="loginLinkUrl"></span>
                        </p>
                        <button id="copyLoginLinkBtn" class="btn btn-secondary">复制链接</button>
                        <p style="margin-top: 10px; color: #666; font-size: 12px;">
                            <strong>注意：</strong>此链接只能使用一次，使用后立即失效。请妥善保管。
                        </p>
                    </div>
                    <div style="margin-top: 30px;">
                        <h3>最近的登录链接</h3>
                        <div class="table-wrapper">
                            <table class="data-table" id="loginTokensTable">
                                <thead>
                                    <tr>
                                        <th>创建时间</th>
                                        <th>创建者</th>
                                        <th>过期时间</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="4" style="text-align:center;">正在加载...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="admin-section">
                <h2>数据库可视化</h2>
                <div class="admin-content">
                    <div class="panel-card" style="margin-bottom: 20px;">
                        <h3>猫咪结构体概览</h3>
                        <p class="info-note">展示系统中每只猫的结构体信息（包含聚合哈希等核心字段）。</p>
                        <div class="status-bar" id="catStructureStatus"></div>
                        <div class="table-wrapper">
                            <table class="data-table" id="catStructureTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>名称</th>
                                        <th>参考图数量</th>
                                        <th>聚合哈希</th>
                                        <th>哈希长度</th>
                                        <th>绝育</th>
                                        <th>芯片</th>
                                        <th>更新时间</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="8" style="text-align:center;">正在加载...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="panel-card" style="margin-bottom: 20px;">
                        <h3>参考图片记录</h3>
                        <p class="info-note">列出所有参考图片，包括是否主图、哈希及特征向量长度。</p>
                        <div class="status-bar" id="referenceTableStatus"></div>
                        <div class="table-wrapper">
                            <table class="data-table" id="referenceTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>猫咪</th>
                                        <th>主图</th>
                                        <th>哈希长度</th>
                                        <th>向量字节数</th>
                                        <th>图片路径</th>
                                        <th>创建时间</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="7" style="text-align:center;">正在加载...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="panel-card">
                        <h3>识别事件日志</h3>
                        <p class="info-note">最近的识别请求记录，包括匹配结果、相似度、哈希距离等信息。</p>
                        <div class="status-bar" id="recognitionEventsStatus"></div>
                        <div class="table-wrapper">
                            <table class="data-table" id="recognitionEventsTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>匹配到的猫</th>
                                        <th>匹配成功</th>
                                        <th>相似度</th>
                                        <th>哈希距离</th>
                                        <th>请求元数据</th>
                                        <th>创建时间</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="7" style="text-align:center;">正在加载...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 流浪猫公益项目. 保留所有权利.</p>
        </div>
    </footer>

    <script>
        // Check if user is admin
        function generateAdminLoginLink() {
            const expiresInHours = parseInt(document.getElementById('loginLinkExpires').value) || 24;
            
            fetch('/api/admin/generate-login-link', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ expires_in_hours: expiresInHours }),
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.login_url) {
                    document.getElementById('loginLinkUrl').textContent = data.login_url;
                    document.getElementById('loginLinkResult').style.display = 'block';
                    loadAdminLoginTokens();
                } else {
                    alert(data.error || '生成登录链接失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('生成登录链接失败，请重试');
            });
        }

        function copyLoginLink() {
            const url = document.getElementById('loginLinkUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('链接已复制到剪贴板');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('复制失败，请手动复制');
            });
        }

        function loadAdminLoginTokens() {
            fetch('/api/admin/login-tokens', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(tokens => {
                const tbody = document.querySelector('#loginTokensTable tbody');
                if (tokens.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">暂无登录链接</td></tr>';
                    return;
                }
                
                tbody.innerHTML = tokens.map(token => {
                    const status = token.used ? '已使用' : (token.expired ? '已过期' : '有效');
                    const statusClass = token.used ? 'status-rejected' : (token.expired ? 'status-pending' : 'status-approved');
                    return `
                        <tr>
                            <td>${new Date(token.created_at).toLocaleString('zh-CN')}</td>
                            <td>${token.created_by_name || token.created_by_email || 'Unknown'}</td>
                            <td>${new Date(token.expires_at).toLocaleString('zh-CN')}</td>
                            <td><span class="status-badge ${statusClass}">${status}</span></td>
                        </tr>
                    `;
                }).join('');
            })
            .catch(error => {
                console.error('Error loading login tokens:', error);
                const tbody = document.querySelector('#loginTokensTable tbody');
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: red;">加载失败</td></tr>';
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAccess();
            loadDashboardData();
            loadResendApiKey();
            loadRecognitionSettings();
            loadRecognitionCatProfiles();
            loadReferenceTable();
            loadRecognitionEvents();
            
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadDashboardData();
                loadRecognitionCatProfiles(true);
                loadReferenceTable(true);
                loadRecognitionEvents(true);
            });
            document.getElementById('saveApiKeyBtn').addEventListener('click', saveResendApiKey);
            document.getElementById('saveFromEmailBtn').addEventListener('click', saveResendFromEmail);
            document.getElementById('saveBaseUrlBtn').addEventListener('click', saveBaseUrl);
            document.getElementById('testApiKeyBtn').addEventListener('click', testResendApiKey);
            document.getElementById('saveNotificationFromEmailBtn').addEventListener('click', saveNotificationFromEmail);
            document.getElementById('saveNotificationEmailsBtn').addEventListener('click', saveNotificationEmails);
            
            const generateLoginLinkBtn = document.getElementById('generateLoginLinkBtn');
            if (generateLoginLinkBtn) {
                generateLoginLinkBtn.addEventListener('click', generateAdminLoginLink);
            }
            const copyLoginLinkBtn = document.getElementById('copyLoginLinkBtn');
            if (copyLoginLinkBtn) {
                copyLoginLinkBtn.addEventListener('click', copyLoginLink);
            }
            loadAdminLoginTokens();

            const catProfileForm = document.getElementById('catProfileForm');
            if (catProfileForm) {
                catProfileForm.addEventListener('submit', handleCatProfileSubmit);
            }
            const uploadReferenceBtn = document.getElementById('uploadReferenceBtn');
            if (uploadReferenceBtn) {
                uploadReferenceBtn.addEventListener('click', uploadReferenceImages);
            }
            const referenceSelect = document.getElementById('referenceCatSelect');
            if (referenceSelect) {
                referenceSelect.addEventListener('change', renderSelectedCatReferencePreview);
            }
            const saveRecognitionSettingsBtn = document.getElementById('saveRecognitionSettingsBtn');
            if (saveRecognitionSettingsBtn) {
                saveRecognitionSettingsBtn.addEventListener('click', saveRecognitionSettings);
            }
        });

        let adminMessageTimeout;
        let recognitionCats = [];
        let referenceRecords = [];
        let recognitionEvents = [];

        function updateStatusBar(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            if (!el) return;
            if (!message) {
                el.textContent = '';
                el.className = 'status-bar';
                return;
            }
            el.textContent = message;
            el.className = `status-bar ${type}`;
        }

        function showActionMessage(message, type = 'info') {
            const bar = document.getElementById('adminMessageBar');
            if (!bar) {
                alert(message);
                return;
            }
            bar.textContent = message;
            bar.className = `admin-message show ${type}`;

            if (adminMessageTimeout) {
                clearTimeout(adminMessageTimeout);
            }

            adminMessageTimeout = setTimeout(() => {
                bar.className = 'admin-message';
                bar.textContent = '';
            }, 4500);
        }
        function checkAdminAccess() {
            fetch('/api/current_user')
                .then(response => response.json())
                .then(user => {
                    if (!user.is_admin) {
                        alert('需要管理员权限访问此页面');
                        window.location.href = '/';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    window.location.href = '/';
                });
        }

        function loadDashboardData() {
            loadCats();
            loadUsers();
            loadAdoptionRequests();
        }

        function loadCats() {
            fetch('/api/admin/cats', { credentials: 'include' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('无法加载猫咪信息，请确认您已登录管理员账号。');
                    }
                    return response.json();
                })
                .then(cats => {
                    const pendingTbody = document.querySelector('#catsTable tbody');
                    if (!pendingTbody) {
                        return;
                    }

                    const pendingCats = [];
                    const declinedCats = [];
                    let approvedCount = 0;

                    cats.forEach(cat => {
                        const isApproved = normalizeFlag(cat.is_approved);
                        const isRejected = normalizeFlag(cat.is_rejected);
                        if (isApproved) {
                            approvedCount += 1;
                        }
                        if (isRejected) {
                            declinedCats.push(cat);
                        } else if (!isApproved) {
                            pendingCats.push(cat);
                        }
                    });

                    document.getElementById('catsCount').textContent = approvedCount;
                    renderCatRows(pendingCats, pendingTbody, 'pending');
                    renderDeclinedCats(declinedCats);
                    bindCatTableEvents();
                })
                .catch(error => {
                    console.error('Error loading cats:', error);
                    showActionMessage(error.message || '加载猫咪信息时出错，请稍后重试。', 'error');
                    const pendingTbody = document.querySelector('#catsTable tbody');
                    if (pendingTbody) {
                        pendingTbody.innerHTML = `<tr><td colspan="9" class="empty-state">${error.message || '加载猫咪信息时出错，请稍后重试。'}</td></tr>`;
                    }
                    renderDeclinedCats([]);
                });
        }

        function renderCatRows(cats, tbody, mode) {
            if (!tbody) return;
            tbody.innerHTML = '';

            if (!cats.length) {
                const emptyRow = document.createElement('tr');
                const message = mode === 'pending'
                    ? '暂无待审核的猫咪提交。'
                    : '暂无数据。';
                emptyRow.innerHTML = `<td colspan="9" class="empty-state">${message}</td>`;
                tbody.appendChild(emptyRow);
                return;
            }

            cats.forEach(cat => {
                const { summaryRow, detailRow } = buildCatRow(cat, mode);
                tbody.appendChild(summaryRow);
                tbody.appendChild(detailRow);
            });
        }

        function renderDeclinedCats(declinedCats) {
            const section = document.getElementById('declinedCatsSection');
            const tbody = document.querySelector('#declinedCatsTable tbody');
            const countLabel = document.getElementById('declinedCatsCount');
            if (!section || !tbody) return;

            if (!declinedCats.length) {
                section.style.display = 'none';
                tbody.innerHTML = '';
                if (countLabel) {
                    countLabel.textContent = '';
                }
                return;
            }

            section.style.display = 'block';
            if (countLabel) {
                countLabel.textContent = `(${declinedCats.length})`;
            }
            renderCatRows(declinedCats, tbody, 'declined');
        }

        function buildCatRow(cat, mode) {
            const catIdValue = Number(cat.id) || 0;
            const catIdSafe = escapeHtml(String(catIdValue));
            const ownerNameRaw = cat.owner_name || '未知用户';
            const ownerEmailRaw = cat.owner_email || '未提供';
            const createdAt = formatDateTime(cat.created_at);
            const catNameRaw = cat.name || '未命名';
            const catAgeRaw = cat.age || '—';
            const catGenderRaw = cat.gender || '—';
            const descriptionRaw = cat.description || '';
            const descriptionPreviewText = truncateText(descriptionRaw || '未提供', 60);
            const defaultSubject = `猫咪审核反馈 - ${catNameRaw}`;
            const ownerIdRaw = cat.owner_id != null ? String(cat.owner_id) : '';
            const ownerIdDisplay = ownerIdRaw || '—';
            const imagePath = cat.image_path ? `/${encodeURI(cat.image_path)}` : '';

            const isApproved = normalizeFlag(cat.is_approved);
            const isRejected = normalizeFlag(cat.is_rejected);
            const statusLabelText = isApproved ? '已批准' : isRejected ? '已拒绝' : '待审核';
            const statusClass = isApproved ? 'status-approved' : isRejected ? 'status-rejected' : 'status-pending';

            const catNameSafe = escapeHtml(catNameRaw);
            const catAgeSafe = escapeHtml(catAgeRaw);
            const catGenderSafe = escapeHtml(catGenderRaw);
            const ownerNameSafe = escapeHtml(ownerNameRaw);
            const ownerEmailSafe = ownerEmailRaw !== '未提供' ? escapeHtml(ownerEmailRaw) : '';
            const descriptionPreviewSafe = escapeHtml(descriptionPreviewText);
            const defaultSubjectSafe = escapeHtml(defaultSubject);
            const ownerIdSafe = escapeHtml(ownerIdDisplay);
            const statusLabelSafe = escapeHtml(statusLabelText);
            const descriptionHtml = descriptionRaw && descriptionRaw.trim()
                ? escapeHtml(descriptionRaw).replace(/\n/g, '<br>')
                : '上传者未提供更多描述。';
            const mailtoHref = ownerEmailRaw !== '未提供' ? `mailto:${encodeURIComponent(ownerEmailRaw)}` : '';
            const mailtoHrefSafe = mailtoHref ? escapeHtml(mailtoHref) : '';
            const feedbackDisabledAttr = ownerIdRaw ? '' : 'disabled';

            let actionButtonsHtml = '';
            if (mode === 'pending') {
                actionButtonsHtml = `
                    <button class="btn btn-primary approve-cat" data-cat-id="${catIdSafe}">批准</button>
                    <button class="btn btn-danger reject-cat" data-cat-id="${catIdSafe}">拒绝</button>
                `;
            } else if (mode === 'declined') {
                actionButtonsHtml = `
                    <button class="btn btn-secondary restore-cat" data-cat-id="${catIdSafe}">恢复为待审核</button>
                `;
            }

            const summaryRow = document.createElement('tr');
            summaryRow.classList.add('cat-summary-row');
            summaryRow.dataset.catId = String(catIdValue);
            summaryRow.innerHTML = `
                <td>${catIdSafe}</td>
                <td>
                    <div class="cat-basic">
                        <span class="cat-name">${catNameSafe}</span>
                        ${cat.image_path ? '<span class="cat-badge">含图片</span>' : ''}
                    </div>
                </td>
                <td>${catAgeSafe}</td>
                <td>${catGenderSafe}</td>
                <td>${descriptionPreviewSafe}</td>
                <td>
                    <div>${ownerNameSafe}</div>
                    ${ownerEmailRaw !== '未提供' ? `<button class="btn-link" data-email="${ownerEmailSafe}">发送邮件</button>` : '<span class="cat-badge">无邮箱</span>'}
                </td>
                <td><span class="status-badge ${statusClass}">${statusLabelSafe}</span></td>
                <td title="${createdAt.full}">${createdAt.date} ${createdAt.time}</td>
                <td>
                    <div class="action-buttons stacked">
                        ${actionButtonsHtml}
                        <button class="btn btn-secondary toggle-details" data-cat-id="${catIdSafe}" aria-expanded="false">展开详情</button>
                    </div>
                </td>
            `;

            const emailButton = summaryRow.querySelector('.btn-link[data-email]');
            if (emailButton && ownerEmailRaw !== '未提供') {
                emailButton.dataset.email = ownerEmailRaw;
            }

            const detailRow = document.createElement('tr');
            detailRow.classList.add('cat-detail-row', 'hidden');
            detailRow.dataset.catId = String(catIdValue);
            detailRow.innerHTML = `
                <td colspan="9">
                    <div class="cat-detail-card">
                        <div class="cat-detail-header">
                            <div>
                                <h3>${catNameSafe || '未命名猫咪'}</h3>
                                <div style="color:#666;font-size:0.9rem;">
                                    提交时间：${createdAt.full}
                                </div>
                            </div>
                            <button class="btn btn-secondary toggle-details" data-cat-id="${catIdSafe}" aria-expanded="true">收起详情</button>
                        </div>
                        <div class="cat-detail-body">
                            <div class="cat-image-wrapper">
                                ${cat.image_path ? `
                                    <img src="${imagePath}" alt="${catNameSafe || '猫咪图片'}" class="cat-detail-image" onerror="this.replaceWith(createImageFallback())">
                                ` : `
                                    <div class="cat-detail-placeholder">未上传图片</div>
                                `}
                            </div>
                            <div class="cat-meta">
                                <dl>
                                    <dt>猫咪名称</dt><dd>${catNameSafe}</dd>
                                    <dt>年龄</dt><dd>${catAgeSafe}</dd>
                                    <dt>性别</dt><dd>${catGenderSafe}</dd>
                                    <dt>当前状态</dt><dd>${statusLabelSafe}</dd>
                                    <dt>上传者</dt><dd>${ownerNameSafe}</dd>
                                    <dt>上传者邮箱</dt><dd>${ownerEmailRaw !== '未提供' ? `<a href="${mailtoHrefSafe}">${ownerEmailSafe}</a>` : '未提供'}</dd>
                                    <dt>上传者 ID</dt><dd>${ownerIdSafe}</dd>
                                    <dt>猫咪编号</dt><dd>#${catIdSafe}</dd>
                                </dl>
                            </div>
                            <div class="cat-description">
                                <strong>猫咪描述</strong>
                                <p style="margin-top:8px;">${descriptionHtml}</p>
                            </div>
                            <div class="cat-feedback">
                                <label for="feedback-subject-${catIdSafe}" style="display:block;margin-bottom:6px;font-weight:600;">向上传者发送反馈</label>
                                <input type="text" id="feedback-subject-${catIdSafe}" placeholder="反馈主题" value="${defaultSubjectSafe}">
                                <textarea id="feedback-message-${catIdSafe}" placeholder="请输入您要发送给上传者的反馈内容，例如需要补充的资料或审核结果说明。"></textarea>
                                <div class="feedback-actions">
                                    <button class="btn btn-secondary reset-feedback" data-cat-id="${catIdSafe}">清空</button>
                                    <button class="btn btn-primary send-feedback" data-cat-id="${catIdSafe}" data-owner-id="${escapeHtml(ownerIdRaw)}" ${feedbackDisabledAttr}>发送反馈</button>
                                </div>
                                <div class="feedback-status" id="feedback-status-${catIdSafe}">${ownerIdRaw ? '' : '无法发送反馈：缺少上传者信息。'}</div>
                            </div>
                        </div>
                    </div>
                </td>
            `;

            const sendButton = detailRow.querySelector('.send-feedback');
            if (sendButton) {
                if (ownerIdRaw) {
                    sendButton.dataset.ownerId = ownerIdRaw;
                } else {
                    sendButton.dataset.ownerId = '';
                    sendButton.setAttribute('disabled', 'disabled');
                }
            }

            return { summaryRow, detailRow };
        }

        let catTableEventsBound = false;

        function bindCatTableEvents() {
            if (catTableEventsBound) return;
            document.addEventListener('click', handleCatTableClick);
            catTableEventsBound = true;
        }

        function handleCatTableClick(event) {
            const target = event.target;
            if (!target) return;

            const toggleButton = target.closest('.toggle-details');
            if (toggleButton) {
                event.preventDefault();
                const catId = toggleButton.dataset.catId;
                toggleCatDetail(catId);
                return;
            }

            const approveButton = target.closest('.approve-cat');
            if (approveButton) {
                event.preventDefault();
                if (approveButton.disabled) return;
                const catId = Number(approveButton.dataset.catId);
                if (!Number.isNaN(catId)) {
                    approveCat(catId);
                }
                return;
            }

            const rejectButton = target.closest('.reject-cat');
            if (rejectButton) {
                event.preventDefault();
                if (rejectButton.disabled) return;
                const catId = Number(rejectButton.dataset.catId);
                if (!Number.isNaN(catId)) {
                    rejectCat(catId);
                }
                return;
            }

            const restoreButton = target.closest('.restore-cat');
            if (restoreButton) {
                event.preventDefault();
                if (restoreButton.disabled) return;
                const catId = Number(restoreButton.dataset.catId);
                if (!Number.isNaN(catId)) {
                    restoreCat(catId);
                }
                return;
            }

            const emailButton = target.closest('.btn-link[data-email]');
            if (emailButton) {
                event.preventDefault();
                const email = emailButton.dataset.email || emailButton.getAttribute('data-email');
                if (email) {
                    window.location.href = `mailto:${encodeURIComponent(email)}`;
                }
                return;
            }

            const sendButton = target.closest('.send-feedback');
            if (sendButton) {
                event.preventDefault();
                if (sendButton.disabled) return;
                const catId = Number(sendButton.dataset.catId);
                const ownerId = Number(sendButton.dataset.ownerId);
                sendFeedback(catId, ownerId);
                return;
            }

            const resetButton = target.closest('.reset-feedback');
            if (resetButton) {
                event.preventDefault();
                const catId = Number(resetButton.dataset.catId);
                resetFeedback(catId);
            }
        }

        function toggleCatDetail(catId) {
            const summaryRow = document.querySelector(`.cat-summary-row[data-cat-id="${catId}"]`);
            const detailRow = document.querySelector(`.cat-detail-row[data-cat-id="${catId}"]`);
            if (!summaryRow || !detailRow) return;

            const expanded = detailRow.classList.toggle('hidden');
            const toggleButtons = document.querySelectorAll(`.toggle-details[data-cat-id="${catId}"]`);
            toggleButtons.forEach(btn => {
                const isExpanded = !expanded;
                btn.textContent = isExpanded ? '收起详情' : '展开详情';
                btn.setAttribute('aria-expanded', String(isExpanded));
            });

            if (!expanded) {
                detailRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function truncateText(text, limit = 60) {
            if (!text) return '';
            const trimmed = text.trim();
            if (trimmed.length <= limit) return trimmed;
            return trimmed.slice(0, limit) + '…';
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function normalizeFlag(value) {
            return value === true || value === 1 || value === '1';
        }

        function formatDateTime(value) {
            if (!value) {
                return { date: '—', time: '', full: '—' };
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return { date: value, time: '', full: value };
            }
            return {
                date: date.toLocaleDateString(),
                time: date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                full: date.toLocaleString()
            };
        }

        function createImageFallback() {
            const placeholder = document.createElement('div');
            placeholder.className = 'cat-detail-placeholder';
            placeholder.textContent = '图片加载失败';
            return placeholder;
        }

        function setCatActionButtonsLoading(catId, action, isLoading, loadingText) {
            const selectorMap = {
                approve: '.approve-cat',
                reject: '.reject-cat',
                restore: '.restore-cat'
            };
            const selector = selectorMap[action];
            if (!selector) return;
            const buttons = document.querySelectorAll(`${selector}[data-cat-id="${catId}"]`);
            buttons.forEach(button => {
                if (isLoading) {
                    if (!button.dataset.originalText) {
                        button.dataset.originalText = button.textContent;
                    }
                    button.disabled = true;
                    if (loadingText) {
                        button.textContent = loadingText;
                    }
                } else {
                    button.disabled = false;
                    if (button.dataset.originalText) {
                        button.textContent = button.dataset.originalText;
                        delete button.dataset.originalText;
                    }
                }
            });
        }

        function sendFeedback(catId, ownerId) {
            const statusEl = document.getElementById(`feedback-status-${catId}`);
            const subjectInput = document.getElementById(`feedback-subject-${catId}`);
            const messageInput = document.getElementById(`feedback-message-${catId}`);

             if (!statusEl) {
                showActionMessage('未找到反馈区域，请刷新页面后重试。', 'error');
                return;
            }

            if (!ownerId) {
                statusEl.textContent = '无法发送反馈：缺少上传者信息。';
                statusEl.style.color = '#dc3545';
                return;
            }

            const subject = (subjectInput?.value || '').trim() || `猫咪审核反馈 - #${catId}`;
            const message = (messageInput?.value || '').trim();

            if (!message) {
                statusEl.textContent = '请先输入要发送的反馈内容。';
                statusEl.style.color = '#dc3545';
                return;
            }

            statusEl.textContent = '正在发送反馈，请稍候…';
            statusEl.style.color = '#666';

            fetch('/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    receiver_id: ownerId,
                    subject,
                    content: message
                })
            })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok) {
                    statusEl.textContent = '反馈已成功发送给上传者。';
                    statusEl.style.color = '#4CAF50';
                    showActionMessage('反馈已发送给上传者。', 'success');
                    if (messageInput) {
                        messageInput.value = '';
                    }
                } else {
                    throw new Error(data.error || '发送反馈失败，请稍后重试。');
                }
            })
            .catch(error => {
                statusEl.textContent = error.message;
                statusEl.style.color = '#dc3545';
                showActionMessage(error.message, 'error');
            });
        }

        function resetFeedback(catId) {
            const subjectInput = document.getElementById(`feedback-subject-${catId}`);
            const messageInput = document.getElementById(`feedback-message-${catId}`);
            const statusEl = document.getElementById(`feedback-status-${catId}`);

            if (subjectInput) {
                subjectInput.value = subjectInput.defaultValue || `猫咪审核反馈 - #${catId}`;
            }
            if (messageInput) {
                messageInput.value = '';
            }
            if (statusEl) {
                statusEl.textContent = '';
                statusEl.style.color = '#666';
            }
        }

        function loadUsers() {
            fetch('/api/users')
                .then(response => response.json())
                .then(users => {
                    document.getElementById('usersCount').textContent = users.length;
                    const tbody = document.querySelector('#usersTable tbody');
                    tbody.innerHTML = '';
                    
                    users.forEach(user => {
                        const row = tbody.insertRow();
                        const isVerified = user.is_verified !== undefined ? user.is_verified : false;
                        const verifiedStatus = isVerified
                            ? '<span class="status-badge status-approved">已验证</span>'
                            : '<span class="status-badge status-pending">未验证</span>';
                        const verifyButton = !user.is_admin
                            ? (isVerified
                                ? `<button class="btn btn-secondary" onclick="toggleUserVerification(${user.id}, false)">取消验证</button>`
                                : `<button class="btn btn-primary" onclick="toggleUserVerification(${user.id}, true)">验证用户</button>`)
                            : '';
                        const deleteButton = !user.is_admin
                            ? `<button class="btn btn-danger" onclick="deleteUser(${user.id})">删除</button>`
                            : '';

                        row.innerHTML = `
                            <td>${user.id}</td>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>${user.is_admin ? '管理员' : '普通用户'}</td>
                            <td>${verifiedStatus}</td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="action-buttons">
                                    ${verifyButton}
                                    ${user.is_admin ? '' : '<button class="btn btn-secondary">设为管理员</button>'}
                                    ${deleteButton}
                                </div>
                            </td>
                        `;
                    });
                })
                .catch(error => console.error('Error loading users:', error));
        }

        function loadAdoptionRequests() {
            fetch('/api/adoption_requests')
                .then(response => response.json())
                .then(requests => {
                    document.getElementById('requestsCount').textContent = requests.length;
                    const pendingCount = requests.filter(r => r.status === 'pending').length;
                    document.getElementById('pendingRequestsCount').textContent = pendingCount;
                    
                    const tbody = document.querySelector('#requestsTable tbody');
                    tbody.innerHTML = '';
                    
                    requests.forEach(request => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${request.id}</td>
                            <td>${request.cat_name}</td>
                            <td>${request.user_name}</td>
                            <td>${request.user_email}</td>
                            <td>${request.contact_info || '—'}</td>
                            <td>${request.message || '—'}</td>
                            <td>
                                <span class="status-badge status-${request.status}">
                                    ${request.status === 'pending' ? '待处理' : 
                                      request.status === 'approved' ? '已批准' : '已拒绝'}
                                </span>
                            </td>
                            <td>${new Date(request.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="action-buttons">
                                    ${request.status === 'pending' ? `
                                        <button class="btn btn-primary" onclick="updateRequestStatus(${request.id}, 'approved')">批准</button>
                                        <button class="btn btn-danger" onclick="updateRequestStatus(${request.id}, 'rejected')">拒绝</button>
                                    ` : ''}
                                </div>
                            </td>
                        `;
                    });
                })
                .catch(error => console.error('Error loading adoption requests:', error));
        }

        function updateRequestStatus(requestId, status) {
            if (!confirm(`确定将申请 #${requestId} 状态更新为「${status === 'approved' ? '已批准' : '已拒绝'}」吗？`)) {
                return;
            }
            fetch(`/api/adoption_requests/${requestId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ status })
            })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok) {
                    showActionMessage(`申请 #${requestId} 状态已更新。`, 'success');
                    loadAdoptionRequests();
                    loadCats();
                } else {
                    throw new Error(data.error || '状态更新失败');
                }
            })
            .catch(error => {
                console.error('Error updating adoption request:', error);
                showActionMessage(error.message || '状态更新失败', 'error');
            });
        }

        function approveCat(catId) {
            if (!confirm(`确定要批准这只猫咪 (ID: ${catId}) 吗？`)) {
                return;
            }

            setCatActionButtonsLoading(catId, 'approve', true, '批准中…');

            fetch(`/api/cats/${catId}/approve`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json().catch(() => ({})).then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok) {
                    showActionMessage(`猫咪 #${catId} 已批准，可在前台展示。`, 'success');
                    loadCats();
                } else {
                    throw new Error(data.error || '批准失败，请稍后重试。');
                }
            })
            .catch(error => {
                console.error('Error approving cat:', error);
                showActionMessage(error.message || '批准失败，请稍后重试。', 'error');
            })
            .finally(() => {
                setCatActionButtonsLoading(catId, 'approve', false);
            });
        }

        function rejectCat(catId) {
            if (!confirm(`确定要拒绝这只猫咪 (ID: ${catId}) 吗？`)) {
                return;
            }

            setCatActionButtonsLoading(catId, 'reject', true, '拒绝中…');

            fetch(`/api/cats/${catId}/reject`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json().catch(() => ({})).then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok) {
                    showActionMessage(`已拒绝猫咪 #${catId} 的展示请求。`, 'info');
                    loadCats();
                } else {
                    throw new Error(data.error || '拒绝失败，请稍后重试。');
                }
            })
            .catch(error => {
                console.error('Error rejecting cat:', error);
                showActionMessage(error.message || '拒绝失败，请稍后重试。', 'error');
            })
            .finally(() => {
                setCatActionButtonsLoading(catId, 'reject', false);
            });
        }

        function restoreCat(catId) {
            if (!confirm(`确定要将猫咪 (ID: ${catId}) 恢复为待审核状态吗？`)) {
                return;
            }

            setCatActionButtonsLoading(catId, 'restore', true, '恢复中…');

            fetch(`/api/cats/${catId}/restore`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json().catch(() => ({})).then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok) {
                    showActionMessage(`猫咪 #${catId} 已恢复为待审核状态。`, 'info');
                    loadCats();
                } else {
                    throw new Error(data.error || '恢复失败，请稍后重试。');
                }
            })
            .catch(error => {
                console.error('Error restoring cat:', error);
                showActionMessage(error.message || '恢复失败，请稍后重试。', 'error');
            })
            .finally(() => {
                setCatActionButtonsLoading(catId, 'restore', false);
            });
        }

        function logout() {
            fetch('/api/logout', {
                method: 'POST'
            })
            .then(() => {
                window.location.href = '/';
            })
            .catch(error => console.error('Error:', error));
        }

        function loadResendApiKey() {
            fetch('/api/admin/settings/resend-api-key')
                .then(response => response.json())
                .then(data => {
                    const statusEl = document.getElementById('apiKeyStatus');
                    if (data.is_configured) {
                        statusEl.textContent = `API 密钥已配置 (${data.api_key})`;
                        statusEl.style.color = '#4CAF50';
                    } else {
                        statusEl.textContent = 'API 密钥未配置';
                        statusEl.style.color = '#dc3545';
                    }
                })
                .catch(error => {
                    console.error('Error loading API key:', error);
                    document.getElementById('apiKeyStatus').textContent = '加载配置失败';
                });
            
            fetch('/api/admin/settings/resend-from-email')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('resendFromEmail').value = data.from_email || '';
                    const statusEl = document.getElementById('fromEmailStatus');
                    if (data.from_email) {
                        statusEl.textContent = `当前发件人邮箱: ${data.from_email}`;
                        statusEl.style.color = '#4CAF50';
                    } else {
                        statusEl.textContent = '使用默认发件人邮箱: noreply@resend.dev';
                        statusEl.style.color = '#666';
                    }
                })
                .catch(error => {
                    console.error('Error loading from email:', error);
                });
            
            fetch('/api/admin/settings/base-url')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('siteBaseUrl').value = data.base_url || '';
                    const statusEl = document.getElementById('baseUrlStatus');
                    if (data.base_url) {
                        statusEl.textContent = `当前网站 URL: ${data.base_url}`;
                        statusEl.style.color = '#4CAF50';
                    } else {
                        statusEl.textContent = '尚未配置网站 URL，邮件中的链接将使用服务器默认地址。';
                        statusEl.style.color = '#dc3545';
                    }
                })
                .catch(error => {
                    console.error('Error loading base URL:', error);
                });

            fetch('/api/admin/settings/notification-from-email')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('notificationFromEmail').value = data.from_email || '';
                    const statusEl = document.getElementById('notificationFromEmailStatus');
                    if (data.from_email) {
                        statusEl.textContent = `当前通知发件邮箱: ${data.from_email}`;
                        statusEl.style.color = '#4CAF50';
                    } else {
                        statusEl.textContent = '未配置通知发件邮箱，将使用默认 alerts@resend.dev';
                        statusEl.style.color = '#666';
                    }
                })
                .catch(error => {
                    console.error('Error loading notification from email:', error);
                });

            fetch('/api/admin/settings/notification-emails')
                .then(response => response.json())
                .then(data => {
                    const emails = (data.emails || []).join(', ');
                    document.getElementById('notificationEmails').value = emails;
                    const statusEl = document.getElementById('notificationEmailsStatus');
                    if (data.emails && data.emails.length > 0) {
                        statusEl.textContent = `当前成员数量：${data.emails.length}`;
                        statusEl.style.color = '#4CAF50';
                    } else {
                        statusEl.textContent = '尚未配置通知成员邮箱';
                        statusEl.style.color = '#666';
                    }
                })
                .catch(error => {
                    console.error('Error loading notification emails:', error);
                });
        }

        function saveResendApiKey() {
            const apiKey = document.getElementById('resendApiKey').value.trim();
            if (!apiKey) {
                alert('请输入 API 密钥');
                return;
            }

            fetch('/api/admin/settings/resend-api-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('API 密钥保存成功！');
                    document.getElementById('resendApiKey').value = '';
                    loadResendApiKey();
                } else {
                    alert(data.error || '保存失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存失败，请重试');
            });
        }

        function saveResendFromEmail() {
            const fromEmail = document.getElementById('resendFromEmail').value.trim();
            if (!fromEmail) {
                alert('请输入发件人邮箱地址');
                return;
            }

            fetch('/api/admin/settings/resend-from-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ from_email: fromEmail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('发件人邮箱地址保存成功！');
                    loadResendApiKey();
                } else {
                    alert(data.error || '保存失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存失败，请重试');
            });
        }

        function saveBaseUrl() {
            const baseUrl = document.getElementById('siteBaseUrl').value.trim();
            if (!baseUrl) {
                alert('请输入网站 URL');
                return;
            }

            fetch('/api/admin/settings/base-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ base_url: baseUrl })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('网站 URL 保存成功！');
                    loadResendApiKey();
                } else {
                    alert(data.error || '保存失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存失败，请重试');
            });
        }

        function saveNotificationFromEmail() {
            const fromEmail = document.getElementById('notificationFromEmail').value.trim();
            if (!fromEmail) {
                alert('请输入通知发件邮箱');
                return;
            }
            fetch('/api/admin/settings/notification-from-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ from_email: fromEmail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('通知发件邮箱已保存！');
                    loadResendApiKey();
                } else {
                    alert(data.error || '保存失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存失败，请重试');
            });
        }

        function saveNotificationEmails() {
            const rawValue = document.getElementById('notificationEmails').value;
            const normalized = rawValue
                .split(/[\n,]+/)
                .map(item => item.trim())
                .filter(item => item.length > 0);
            fetch('/api/admin/settings/notification-emails', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ emails: normalized })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('通知成员列表已更新！');
                    loadResendApiKey();
                } else {
                    alert(data.error || '保存失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存失败，请重试');
            });
        }

        function testResendApiKey() {
            const apiKey = document.getElementById('resendApiKey').value.trim();
            if (!apiKey) {
                alert('请先输入 API 密钥');
                return;
            }

            // Save first, then test
            fetch('/api/admin/settings/resend-api-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('API 密钥已保存。测试功能需要实际发送邮件，请通过注册新用户来测试。');
                    document.getElementById('resendApiKey').value = '';
                    loadResendApiKey();
                } else {
                    alert(data.error || '保存失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('测试失败，请重试');
            });
        }

        function toggleUserVerification(userId, isVerified) {
            const action = isVerified ? '验证' : '取消验证';
            if (!confirm(`确定要${action}此用户吗？`)) {
                return;
            }

            fetch(`/api/users/${userId}/verify`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ is_verified: isVerified })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(`${action}成功！`);
                    loadUsers();
                } else {
                    alert(data.error || `${action}失败`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`${action}失败，请重试`);
            });
        }
        
        function deleteUser(userId) {
            if (!confirm('确定要删除此用户吗？该操作不可恢复。')) {
                return;
            }
            
            fetch(`/api/users/${userId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('用户已删除！');
                    loadUsers();
                } else {
                    alert(data.error || '删除失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除失败，请重试');
            });
        }

        function handleCatProfileSubmit(event) {
            event.preventDefault();
            updateStatusBar('catProfileStatus', '');

            const name = document.getElementById('profileName').value.trim();
            const gender = document.getElementById('profileGender').value.trim();

            if (!name || !gender) {
                updateStatusBar('catProfileStatus', '请填写猫咪名称和性别。', 'error');
                return;
            }

            const payload = {
                name,
                gender,
                age: document.getElementById('profileAge').value.trim(),
                description: document.getElementById('profileDescription').value.trim(),
                sterilized: document.getElementById('profileSterilized').checked,
                microchipped: document.getElementById('profileMicrochipped').checked,
                unique_markings: document.getElementById('profileUniqueMarkings').value.trim(),
                last_known_location: document.getElementById('profileLocation').value.trim(),
                identification_code: document.getElementById('profileIdentification').value.trim(),
                special_notes: document.getElementById('profileSpecialNotes').value.trim()
            };

            fetch('/api/admin/cat-profiles', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (!ok) {
                    throw new Error(data.error || '保存猫咪档案失败，请稍后重试。');
                }
                updateStatusBar('catProfileStatus', '猫咪档案创建成功。', 'success');
                showActionMessage('新猫咪档案已创建。', 'success');
                document.getElementById('catProfileForm').reset();
                loadCats();
                loadRecognitionCatProfiles();
            })
            .catch(error => {
                updateStatusBar('catProfileStatus', error.message, 'error');
            });
        }

        function loadRecognitionCatProfiles(isRefresh = false) {
            if (!isRefresh) {
                updateStatusBar('catStructureStatus', '正在加载猫咪档案...', 'info');
            }
            fetch('/api/admin/cat-profiles', { credentials: 'include' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('加载猫咪档案失败，请稍后重试。');
                    }
                    return response.json();
                })
                .then(cats => {
                    recognitionCats = cats || [];
                    const select = document.getElementById('referenceCatSelect');
                    if (select) {
                        const previousValue = select.value;
                        if (!recognitionCats.length) {
                            select.innerHTML = '<option value="">暂无猫咪档案</option>';
                        } else {
                            select.innerHTML = recognitionCats.map(cat => {
                                const referenceCount = (cat.reference_images && cat.reference_images.length) || cat.reference_count || 0;
                                const label = `${cat.name} (#${cat.id})${referenceCount ? ` · 参考图:${referenceCount}` : ''}`;
                                return `<option value="${cat.id}">${label}</option>`;
                            }).join('');
                        }
                        if (previousValue && select.querySelector(`option[value="${previousValue}"]`)) {
                            select.value = previousValue;
                        }
                        renderSelectedCatReferencePreview();
                    }
                    renderCatStructureTable();
                    updateStatusBar('catStructureStatus', `共 ${recognitionCats.length} 条猫咪档案。`, 'info');
                })
                .catch(error => {
                    updateStatusBar('referenceUploadStatus', error.message, 'error');
                    updateStatusBar('catStructureStatus', error.message, 'error');
                });
        }

        function renderSelectedCatReferencePreview() {
            const select = document.getElementById('referenceCatSelect');
            const preview = document.getElementById('referencePreview');
            const status = document.getElementById('referenceUploadStatus');
            if (!select || !preview) return;

            preview.innerHTML = '';
            const selectedId = select.value;
            if (!selectedId) {
                if (status) status.textContent = '';
                preview.innerHTML = '<span class="info-note">请选择猫咪后上传参考图像。</span>';
                return;
            }

            const cat = recognitionCats.find(item => String(item.id) === String(selectedId));
            if (!cat) {
                preview.innerHTML = '<span class="info-note">未找到匹配的猫咪档案。</span>';
                return;
            }

            const references = cat.reference_images || [];
            if (!references.length) {
                preview.innerHTML = '<span class="info-note">暂未上传参考图像。</span>';
                return;
            }

            references.forEach(ref => {
                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.flexDirection = 'column';
                wrapper.style.alignItems = 'center';
                wrapper.style.gap = '6px';

                const img = document.createElement('img');
                img.src = `/${ref.image_path}`;
                img.alt = cat.name || '参考图像';
                img.title = `参考图 #${ref.id}${ref.is_primary ? ' · 主展示图' : ''}\n哈希长度: ${ref.hash_length || '未知'}`;
                wrapper.appendChild(img);

                if (ref.is_primary) {
                    const badge = document.createElement('span');
                    badge.className = 'status-badge status-approved';
                    badge.textContent = '主展示图';
                    wrapper.appendChild(badge);
                }
                preview.appendChild(wrapper);
            });
        }

        function uploadReferenceImages() {
            updateStatusBar('referenceUploadStatus', '');
            const catId = document.getElementById('referenceCatSelect').value;
            const fileInput = document.getElementById('catReferenceImages');
            if (!catId) {
                updateStatusBar('referenceUploadStatus', '请先选择需要上传参考图像的猫咪。', 'error');
                return;
            }
            if (!fileInput || !fileInput.files.length) {
                updateStatusBar('referenceUploadStatus', '请至少选择一张图片。', 'error');
                return;
            }

            const formData = new FormData();
            Array.from(fileInput.files).forEach(file => formData.append('images', file));

            const primaryMode = document.getElementById('referencePrimaryMode').value;
            if (primaryMode === 'auto') {
                formData.append('primary_index', '0');
            } else if (primaryMode === 'none') {
                formData.append('primary_index', '-1');
            }

            updateStatusBar('referenceUploadStatus', '正在上传并生成哈希，请稍候…', 'info');

            fetch(`/api/admin/cat-profiles/${catId}/reference-images`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (!ok) {
                    throw new Error(data.error || '上传失败，请稍后重试。');
                }
                updateStatusBar('referenceUploadStatus', '参考图像上传成功。', 'success');
                showActionMessage('参考图像已上传并生成哈希。', 'success');
                document.getElementById('catReferenceImages').value = '';
                loadRecognitionCatProfiles();
                loadReferenceTable(true);
                loadCats();
            })
            .catch(error => {
                updateStatusBar('referenceUploadStatus', error.message, 'error');
            });
        }

        function loadRecognitionSettings() {
            fetch('/api/cat-recognition/settings', { credentials: 'include' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('无法获取识别设置，请稍后重试。');
                    }
                    return response.json();
                })
                .then(settings => {
                    document.getElementById('recognitionThreshold').value = settings.threshold?.toFixed(2) || '';
                    document.getElementById('recognitionMaxResults').value = settings.max_results || 3;
                    document.getElementById('recognitionMaxHamming').value = settings.max_hamming ?? '';
                    document.getElementById('recognitionModelPath').value = settings.model_path || '';
                    document.getElementById('recognitionHashLength').value = settings.hash_length_override || '';

                    const stats = document.getElementById('recognitionStats');
                    if (stats) {
                        const referenceCount = settings.reference_count ?? 0;
                        const catCount = settings.cat_count ?? 0;
                        stats.textContent = `参考图像：${referenceCount} · 档案数量：${catCount} · 运行设备：${settings.device || 'CPU'}`;
                    }
                })
                .catch(error => {
                    updateStatusBar('recognitionSettingsStatus', error.message, 'error');
                });
        }

        function saveRecognitionSettings() {
            updateStatusBar('recognitionSettingsStatus', '正在保存设置…', 'info');
            const thresholdValue = document.getElementById('recognitionThreshold').value;
            const maxResultsValue = document.getElementById('recognitionMaxResults').value;
            const maxHammingValue = document.getElementById('recognitionMaxHamming').value;
            const modelPathValue = document.getElementById('recognitionModelPath').value.trim();
            const hashLengthValue = document.getElementById('recognitionHashLength').value;

            const payload = {};
            if (thresholdValue) payload.threshold = thresholdValue;
            if (maxResultsValue) payload.max_results = maxResultsValue;
            payload.max_hamming = maxHammingValue;
            payload.model_path = modelPathValue;
            payload.hash_length_override = hashLengthValue;

            fetch('/api/admin/cat-recognition/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (!ok) {
                    throw new Error(data.errors ? data.errors.join('，') : (data.error || '保存失败'));
                }
                updateStatusBar('recognitionSettingsStatus', '识别设置已更新。', 'success');
                showActionMessage('识别参数保存成功。', 'success');
                loadRecognitionSettings();
                loadRecognitionCatProfiles();
            })
            .catch(error => {
                updateStatusBar('recognitionSettingsStatus', error.message, 'error');
            });
        }

        function renderCatStructureTable() {
            const tbody = document.querySelector('#catStructureTable tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!recognitionCats.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">暂无猫咪档案。</td></tr>';
                return;
            }
            recognitionCats.forEach(cat => {
                const row = document.createElement('tr');
                const hash = cat.reference_hash_hex || '';
                const hashPreview = hash ? `${hash.slice(0, 12)}…` : '未生成';
                row.innerHTML = `
                    <td>${cat.id}</td>
                    <td>${escapeHtml(cat.name || '未命名')}</td>
                    <td>${cat.reference_count || 0}</td>
                    <td title="${hash}">${hashPreview}</td>
                    <td>${cat.reference_hash_length || '—'}</td>
                    <td>${formatBool(cat.sterilized)}</td>
                    <td>${formatBool(cat.microchipped)}</td>
                    <td>${cat.updated_at || '—'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadReferenceTable(isRefresh = false) {
            if (!isRefresh) {
                updateStatusBar('referenceTableStatus', '正在加载参考图片记录...', 'info');
            }
            fetch('/api/admin/cat-references', { credentials: 'include' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('加载参考图片记录失败，请稍后重试。');
                    }
                    return response.json();
                })
                .then(records => {
                    referenceRecords = records || [];
                    renderReferenceTable();
                    updateStatusBar('referenceTableStatus', `共 ${referenceRecords.length} 条参考图片记录。`, 'info');
                })
                .catch(error => {
                    updateStatusBar('referenceTableStatus', error.message, 'error');
                });
        }

        function renderReferenceTable() {
            const tbody = document.querySelector('#referenceTable tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!referenceRecords.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">暂无参考图片。</td></tr>';
                return;
            }
            referenceRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.id}</td>
                    <td>${escapeHtml(record.cat_name || (record.cat_id ? `#${record.cat_id}` : '未知'))}</td>
                    <td>${formatBool(record.is_primary)}</td>
                    <td>${record.hash_length || '—'}</td>
                    <td>${record.embedding_bytes || 0}</td>
                    <td title="${record.image_path || ''}">${escapeHtml(record.image_path || '—')}</td>
                    <td>${record.created_at || '—'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadRecognitionEvents(isRefresh = false) {
            if (!isRefresh) {
                updateStatusBar('recognitionEventsStatus', '正在加载识别事件日志...', 'info');
            }
            fetch('/api/admin/cat-recognition/events', { credentials: 'include' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('加载识别日志失败，请稍后重试。');
                    }
                    return response.json();
                })
                .then(events => {
                    recognitionEvents = events || [];
                    renderRecognitionEvents();
                    updateStatusBar('recognitionEventsStatus', `显示最近 ${recognitionEvents.length} 条识别事件。`, 'info');
                })
                .catch(error => {
                    updateStatusBar('recognitionEventsStatus', error.message, 'error');
                });
        }

        function renderRecognitionEvents() {
            const tbody = document.querySelector('#recognitionEventsTable tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!recognitionEvents.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">暂无识别事件记录。</td></tr>';
                return;
            }
            recognitionEvents.forEach(event => {
                const metadata = event.request_metadata;
                let metadataText = '';
                if (metadata && typeof metadata === 'object') {
                    metadataText = Object.entries(metadata)
                        .map(([key, value]) => `${key}: ${value}`)
                        .join(', ');
                } else if (metadata) {
                    metadataText = String(metadata);
                } else {
                    metadataText = '—';
                }
                const similarity = typeof event.match_score === 'number'
                    ? `${Math.round(event.match_score * 100)}%`
                    : '—';
                const distance = event.hash_distance !== null && event.hash_distance !== undefined
                    ? event.hash_distance
                    : '—';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${event.id}</td>
                    <td>${escapeHtml(event.cat_name || (event.cat_id ? `#${event.cat_id}` : '未匹配'))}</td>
                    <td>${event.matched ? '成功' : '未命中'}</td>
                    <td>${similarity}</td>
                    <td>${distance}</td>
                    <td title="${metadataText}">${escapeHtml(metadataText)}</td>
                    <td>${event.created_at || '—'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function formatBool(value) {
            return value ? '是' : '否';
        }

    </script>
</body>
</html>